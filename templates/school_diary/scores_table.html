{% extends 'base.html' %}
{% load dict_get_item %}
{% block title %}Оцінки {{ classroom.name }} класу з {{ subject.name }}{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4">Оцінки {{ classroom.name }} класу з предмету "{{ subject.name }}"</h2>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>Учень</th>
                    {% for date in dates %}
                        <th>{{ date }}</th>
                    {% endfor %}
                    <th>Додати оцінку</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                    <tr>
                        <td class="text-start">{{ student.first_name }} {{ student.last_name }}</td>
                        {% for date in dates %}
                            {% with grade=grade_dict|get_item:student|get_item:date %}
                                <td style="cursor: pointer;" 
                                    onclick="openGradeModal(
                                        '{{ student.id }}', 
                                        '{{ student.first_name }} {{ student.last_name }}',
                                        '{{ grade.score|default:"" }}',
                                        '{{ grade.id|default:"" }}',
                                        '{{ date|date:"Y-m-d" }}'
                                    )">
                                    {{ grade|default:"-" }}
                                </td>
                            {% endwith %}
                        {% endfor %}
                        <td>
                            <button 
                                class="btn btn-sm btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addGradeModal" 
                                data-student="{{ student.id }}"
                                data-name="{{ student.first_name }} {{ student.last_name }}">
                                +
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% include 'school_diary/add_grade.html' %}
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var modal = document.getElementById('addGradeModal');
        modal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var studentId = button.getAttribute('data-student');
            var studentName = button.getAttribute('data-name');

            var form = document.getElementById('addGradeForm');
            form.action = "{% url 'diary:add_grade' subject.id classroom.id 0 %}".replace("0", studentId);

            document.getElementById('studentName').textContent = studentName;
        });
    });

    function openGradeModal(studentId, studentName, currentScore, gradeId, date) {
    document.getElementById('studentName').textContent = studentName;
    document.getElementById('score').value = currentScore;
    document.getElementById('date').value = date;
    
    var gradeIdElement = document.getElementById('gradeId');
    if (gradeIdElement) {
        gradeIdElement.value = gradeId;
    }
    
    var form = document.getElementById('addGradeForm');
    form.action = "{% url 'diary:add_grade' subject.id classroom.id 0 %}".replace("0", studentId);
    
    var modal = new bootstrap.Modal(document.getElementById('addGradeModal'));
    modal.show();
}
</script>
{% endblock %}
