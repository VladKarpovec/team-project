{% extends "base.html" %}
{% load static %}

{% block title %}–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è{% endblock %}

{% block content %}
<h2 class="mb-4">–°–ø–∏—Å–æ–∫ –æ–ø–∏—Ç—É–≤–∞–Ω—å</h2>

{% if request.user.is_staff %}
  <div class="mb-3">
    <a href="{% url 'polls:survey_create' %}" class="btn btn-success">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</a>
  </div>
{% endif %}

<!-- CSRF-—Ç–æ–∫–µ–Ω –¥–ª—è JavaScript -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="list-group">
  {% for survey in surveys %}
    <div class="list-group-item d-flex justify-content-between align-items-center" id="survey-{{ survey.id }}">
      <div>
        <h5 class="mb-1">{{ survey.title }}</h5>
        <p class="mb-0 text-muted">{{ survey.description }}</p>
      </div>
      <div class="btn-group">
        {% if survey.id in responded_ids %}
            <a href="{% url 'polls:survey_detail' survey.id %}" class="btn btn-outline-info btn-sm">üîÅ –ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏</a>
        {% else %}
            <a href="{% url 'polls:survey_detail' survey.id %}" class="btn btn-outline-primary btn-sm">–ü—Ä–æ–π—Ç–∏</a>
        {% endif %}

        {% if request.user.is_staff %}
          <a href="{% url 'polls:survey_edit' survey.id %}" class="btn btn-outline-warning btn-sm">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmDelete({{ survey.id }}, '{{ survey.title|escapejs }}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          <a href="{% url 'polls:survey_results' survey.id %}" class="btn btn-outline-success btn-sm">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</a>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="text-muted">–û–ø–∏—Ç—É–≤–∞–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
  {% endfor %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="margin:10% auto; background:white; padding:20px; border-radius:8px; max-width:400px;">
    <h5 id="modalTitle">–í–∏–¥–∞–ª–∏—Ç–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</h5>
    <p id="modalText"></p>
    <div class="text-end">
      <button class="btn btn-secondary" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn btn-danger" onclick="submitDelete()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
    </div>
  </div>
</div>

<script>
let deleteSurveyId = null;

function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function confirmDelete(id, title) {
  deleteSurveyId = id;
  document.getElementById("modalText").innerText = `–í–∏ —Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ ¬´${title}¬ª?`;
  document.getElementById("deleteModal").style.display = "block";
}

function closeModal() {
  document.getElementById("deleteModal").style.display = "none";
  deleteSurveyId = null;
}

function submitDelete() {
  if (!deleteSurveyId) return;

  fetch(`/polls/${deleteSurveyId}/delete/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken(),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ confirm: true })
  })
  .then(response => {
    if (response.ok) {
      document.getElementById(`survey-${deleteSurveyId}`).remove();
      closeModal();
    } else {
      alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ.");
    }
  })
  .catch(() => alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è."));
}
</script>
{% endblock %}