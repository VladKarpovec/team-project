{% extends "base.html" %}
{% block title %}–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è{% endblock %}

{% block content %}
<h2 class="mb-4">{% if form.instance.pk %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏{% endif %} –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</h2>

<form method="post" id="survey-form">
    {% csrf_token %}
    <div class="mb-3">
        <label class="form-label">–ù–∞–∑–≤–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</label>
        {{ form.title }}
    </div>
    <div class="mb-3">
        <label class="form-label">–û–ø–∏—Å</label>
        {{ form.description }}
    </div>

    <hr>
    <h4>–ü–∏—Ç–∞–Ω–Ω—è</h4>
    <div id="questions-container"></div>

    <button type="button" class="btn btn-outline-primary mb-3" onclick="addQuestion()">‚ûï –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button>
    <br>
    <button type="submit" class="btn btn-success">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</button>
</form>

<script>
let questionIndex = 0;

// –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
{% if form.instance.pk %}
    {% for question in form.instance.questions.all %}
        addQuestionPrefilled(
            `{{ question.text|escapejs }}`,
            `{{ question.question_type }}`,
            `{% for choice in question.choices.all %}{{ choice.text|escapejs }}\n{% endfor %}`.trim()
        );
    {% endfor %}
{% endif %}

function addQuestion() {
    addQuestionPrefilled("", "text", "");
}

function addQuestionPrefilled(text, type, options) {
    const container = document.getElementById("questions-container");
    const questionId = `question-${questionIndex}`;
    const html = `
        <div class="card mb-3 p-3" id="${questionId}">
            <div class="d-flex justify-content-between align-items-start">
                <div style="flex-grow:1">
                    <div class="mb-2">
                        <label>–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è</label>
                        <input type="text" name="question_${questionIndex}_text" class="form-control" required value="${text}">
                    </div>
                    <div class="mb-2">
                        <label>–¢–∏–ø –ø–∏—Ç–∞–Ω–Ω—è</label>
                        <select name="question_${questionIndex}_type" class="form-select" onchange="toggleOptions(this, ${questionIndex})">
                            <option value="text" ${type === "text" ? "selected" : ""}>–¢–µ–∫—Å—Ç–æ–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</option>
                            <option value="radio" ${type === "radio" ? "selected" : ""}>–û–¥–∏–Ω –≤–∞—Ä—ñ–∞–Ω—Ç</option>
                            <option value="checkbox" ${type === "checkbox" ? "selected" : ""}>–ö—ñ–ª—å–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤</option>
                        </select>
                    </div>
                    <div class="mb-2" id="options_${questionIndex}" style="display: ${type === "text" ? "none" : "block"};">
                        <label>–í–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Ä—è–¥–æ–∫)</label>
                        <textarea name="question_${questionIndex}_options" class="form-control" rows="3">${options}</textarea>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger ms-3 mt-1" onclick="removeQuestion('${questionId}')">üóë</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML("beforeend", html);
    questionIndex++;
}

function toggleOptions(select, index) {
    const optionsDiv = document.getElementById(`options_${index}`);
    optionsDiv.style.display = (select.value === "text") ? "none" : "block";
}

function removeQuestion(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}
</script>
{% endblock %}